# Блокировка повторного прохождения теста

## Реализованная защита

### 1. Удалена кнопка "Начать заново"
- На странице результатов больше нет возможности начать тест заново
- Показывается только результат и сообщение о завершении

### 2. localStorage для отслеживания
При завершении теста сохраняется ID сессии в `localStorage`:
```javascript
localStorage.setItem('quiz_completed_session', sessionId);
```

### 3. Автоматическая проверка при загрузке
При каждой загрузке страницы:
- Проверяется `localStorage` на наличие завершенной сессии
- Проверяется в Supabase, действительно ли эта сессия завершена
- Если да - автоматически показывается страница результатов
- Попытки обойти через URL блокируются

### 4. Защита на уровне UI
- Форма входа блокируется если тест уже пройден
- Кнопки квиза отключаются если тест завершен
- Страница квиза не отображается для завершенных сессий

### 5. Защита на уровне логики
- `startQuiz()` проверяет флаг `isCompleted`
- `setStudentInfo()` проверяет завершенные сессии
- `checkAnswer()` не сработает для завершенных тестов

## Как работает защита

### Первое прохождение:
1. Ученик вводит имя и фамилию
2. Создается сессия в Supabase
3. Проходит тест
4. При завершении:
   - Обновляется `completed_at` в БД
   - Сохраняется sessionId в localStorage
   - Устанавливается флаг `isCompleted = true`

### Попытки обойти:

#### Попытка 1: Обновить страницу (F5)
✅ **Заблокировано**
- При загрузке проверяется localStorage
- Находится завершенная сессия
- Автоматически показывается результат

#### Попытка 2: Открыть в новой вкладке
✅ **Заблокировано**
- localStorage общий для всех вкладок одного браузера
- Везде будет показываться результат

#### Попытка 3: Очистить localStorage через DevTools
✅ **Частично заблокировано**
- Если очистить localStorage вручную
- Но сессия остается в Supabase с `completed_at`
- Ученик может создать новую сессию (см. раздел "Ограничения")

#### Попытка 4: Открыть в режиме инкогнито
⚠️ **Не заблокировано** (см. раздел "Ограничения")

#### Попытка 5: Другой браузер
⚠️ **Не заблокировано** (см. раздел "Ограничения")

## Ограничения текущей защиты

### 1. Защита на уровне браузера
- Привязка к localStorage конкретного браузера
- Не защищает от использования другого браузера
- Не защищает от режима инкогнито

### 2. Отсутствие идентификации ученика
- Нет проверки email или ID студента
- Один ученик может создать несколько сессий с разных устройств

## Рекомендации для усиления защиты

### Вариант 1: Email + Проверка в БД (Рекомендуется)
Добавить поле email и проверять в Supabase:
```sql
SELECT * FROM quiz_sessions 
WHERE LOWER(first_name) = LOWER($1) 
  AND LOWER(last_name) = LOWER($2)
  AND completed_at IS NOT NULL
LIMIT 1;
```

Если найдена завершенная сессия с таким именем - блокировать.

### Вариант 2: IP-адрес (Средняя надежность)
Сохранять IP при создании сессии и проверять повторные попытки.

Проблемы:
- Динамические IP
- Общие IP в школе/университете

### Вариант 3: Полная авторизация через Supabase Auth
- Ученики создают аккаунт
- Жесткая привязка: 1 аккаунт = 1 попытка
- Самый надежный, но требует больше работы

### Вариант 4: Уникальный код доступа
- Учитель генерирует уникальные коды для каждого ученика
- Код можно использовать только один раз
- Хранится в отдельной таблице `access_codes`

## Для учителя

### Просмотр всех попыток:
```sql
SELECT 
  first_name,
  last_name,
  total_score,
  completed_at,
  created_at
FROM quiz_sessions
WHERE completed_at IS NOT NULL
ORDER BY completed_at DESC;
```

### Поиск дублей (одинаковые имена):
```sql
SELECT 
  first_name,
  last_name,
  COUNT(*) as attempts,
  ARRAY_AGG(total_score ORDER BY completed_at) as scores
FROM quiz_sessions
WHERE completed_at IS NOT NULL
GROUP BY first_name, last_name
HAVING COUNT(*) > 1
ORDER BY attempts DESC;
```

### Удаление сессии (если нужно разрешить повторное прохождение):
```sql
DELETE FROM quiz_sessions 
WHERE id = 'SESSION_ID_HERE';
```

## Очистка для тестирования

Если нужно протестировать повторно:

### Вариант 1: Очистить localStorage в браузере
1. Откройте DevTools (F12)
2. Console
3. Выполните: `localStorage.clear()`
4. Обновите страницу

### Вариант 2: Удалить сессию из Supabase
1. Откройте Table Editor
2. Найдите свою сессию в `quiz_sessions`
3. Удалите запись

### Вариант 3: Использовать режим инкогнито
Новое окно в режиме инкогнито = чистый localStorage

## Вывод

Текущая реализация:
- ✅ Защищает от случайных повторных попыток
- ✅ Защищает от простых обходов через UI
- ✅ Достаточна для честных учеников
- ⚠️ Не защищает от намеренных обходов (другой браузер/инкогнито)

Для production в школе/университете рекомендуется добавить email-валидацию или систему уникальных кодов доступа.
